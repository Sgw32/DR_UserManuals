%%% Headers and footers, page styles
\usepackage{fancyhdr}       % custom headers and footers
% \usepackage{extramarks}     % extra marks for headers and footers

%% Disable `fancyhdr` warning: "\fancyhead's `E' option without twoside option is useless.
%%                               Please consider using the `twoside' option"
\makeatletter
\def\f@nch@fancyhf@Echeck#1{}
\makeatother

\newlength{\headerpadding}  % left/right padding of header
\setlength{\headerpadding}{2pt}
% \RenewDocumentCommand{\chaptermark}{m}{\markboth{\chaptername\ \thechapter.\ #1}{\chaptername\ \thechapter.\ #1}}
% \RenewDocumentCommand{\sectionmark}{m}{\markright{\thesection.\ #1}}

%% Style of the header rule and decorations
\renewcommand*{\headrulewidth}{0.9pt}
\tikzset{
    header rule/.style={HeaderRuleColor},
    header decor/.style={HeaderRuleColor,line width=1.0pt,-{Diamond[open]},overlay},
}

%% Default header style (includes a rule with decorations)
\fancypagestyle{header}{
    \renewcommand*{\headrule}{
        \ifFANCY % add header rule with fancy decorations
            \tikz[baseline=-1em]{
                \fill[header rule] (0,0) rectangle (\headwidth,\headrulewidth);
                \draw[header decor] (\headwidth,\headrulewidth/2) -- ++( 7pt,0);
                \draw[header decor] (         0,\headrulewidth/2) -- ++(-7pt,0);
            }
        \else
            \textcolor{HeaderRuleColor}{\rule[1em]{\headwidth}{0.9pt}}%
        \fi
    }
    \fancyhead[LO]{\hspace{\headerpadding}\textcolor{HeaderColor}{\textsf{\nouppercase{\leftmark}}}}
    % \fancyhead[LO]{\hspace{\headerpadding}\textcolor{HeaderColor}{\textsf{\nouppercase{\rightmark}}}}
    \fancyhead[RE]{\textcolor{HeaderColor}{\textsf{\nouppercase{\rightmark}}}\hspace{\headerpadding}}
    \fancyhead[RO]{\textbf{\thepage}\hspace{\headerpadding}}
    \fancyhead[LE]{\hspace{\headerpadding}\textbf{\thepage}}
    \ifWIP % show draft watermark in footer
        \fancyfoot[C]{\vskip1ex\relax \ttfamily\textcolor{black!15}{Draft - \today}}
    \else
        \fancyfoot{}
    \fi
}
%% For chapter pages, the `plain` style is used
\fancypagestyle{plain}[header]{
    %% NOTE: following does not handle properly the even-numbered pages for the two-sided printing
    \renewcommand*{\headrule}{
        \hfill\tikz[baseline=-1em]{
            \fill[header rule, path fading=west] (0,0) rectangle (0.45\headwidth,\headrulewidth);
            \ifFANCY % add fancy decoration
                \draw[header decor] (0.45\headwidth,\headrulewidth/2) -- ++(7pt,0);
            \fi
        }
    }
    \fancyhead[LO,RE]{} % leave only the page number
}
\pagestyle{header} % set up default header style
